name: Spring Boot CD   # 워크플로우 이름 (CD: 배포 전용)

on:
  workflow_run:
    workflows: ["Spring Boot CI"]   # CI 워크플로우 이름
    types:
      - completed                   # CI가 끝났을 때 트리거

jobs:
  deploy:
    # CI 결과가 success일 때만 CD 실행
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    # GitHub Actions 실행 환경 (임시 Ubuntu 서버)
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to EC2
        # EC2에 SSH 접속해서 명령을 실행해주는 액션
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}   # EC2 퍼블릭 IP 또는 도메인
          username: ubuntu               # EC2 로그인 사용자
          key: ${{ secrets.EC2_KEY }}    # EC2 접속용 SSH 개인키 (Secrets)

          # EC2 서버 안에서 실행될 실제 배포 스크립트
          script: |
            # 1. Docker Hub에서 최신 Spring Boot 이미지 다운로드
            docker pull ugcadman/cicd-springboot:latest

            # 2. 기존 컨테이너 중지 (없어도 에러 안 나게 처리)
            docker stop cntr-springboot || true

            # 3. 기존 컨테이너 삭제 (이전 버전 정리)
            docker rm cntr-springboot || true

            # 4. 새 컨테이너 실행
            # -d                : 백그라운드 실행
            # --name             : 컨테이너 이름 지정
            # -p 80:9000         : EC2의 80번 포트를 컨테이너 9000번 포트와 연결
            # ugcadman/...:latest: 실행할 도커 이미지
            docker run -d --name cntr-springboot -p 80:9000 ugcadman/cicd-springboot:latest